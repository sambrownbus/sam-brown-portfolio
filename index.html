<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Sam Brown — Portfolio</title>
    <link rel="stylesheet" href="./styles.css"/>
    <style>body{background:#f5f2ee;color:#111;margin:0}</style>
  </head>
  <body>
    <!-- Header -->
    <header class="site-head">
      <div class="logo-wrap">
        <img src="./assets/signature.svg" alt="Sam Brown signature" class="logo"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <span class="logo-fallback">Sam Brown</span>
      </div>
      <nav class="filters" id="filters"></nav>
    </header>

    <!-- Gallery -->
    <main>
      <section id="gallery" class="gallery"></section>
    </main>

    <!-- Footer -->
    <footer class="site-foot">
      <p>© <span id="year"></span> Sam Brown — Brand | Film | Design</p>
    </footer>

    <!-- Data loader + app -->
    <script>
      document.getElementById('year').textContent = new Date().getFullYear();

      const FALLBACK_POSTER = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800" viewBox="0 0 1200 800">
          <rect width="100%" height="100%" fill="#eae6df"/>
          <rect x="40" y="40" width="1120" height="720" rx="10" fill="#ddd"/>
          <text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle"
                font-family="Arial, Helvetica, sans-serif" font-size="28" fill="#444">media</text>
        </svg>
      `);

      async function loadProjects() {
        // 1) Try JSON (preferred)
        try {
          const res = await fetch('./projects.json', {cache:'no-store'});
          if (res.ok) {
            const data = await res.json();
            if (Array.isArray(data)) return data;
          }
        } catch (e) {}

        // 2) Try JS fallback (window.PROJECTS)
        try {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = './projects.js'; s.onload = resolve; s.onerror = reject;
            document.head.appendChild(s);
          });
          if (Array.isArray(window.PROJECTS)) return window.PROJECTS;
        } catch (e) {}

        // 3) Try localStorage (last good copy)
        try {
          const cached = localStorage.getItem('SB_PROJECTS');
          if (cached) return JSON.parse(cached);
        } catch (e) {}

        return [];
      }

      function startApp(PROJECTS) {
        // keep a cached copy for project.html direct opens
        try { localStorage.setItem('SB_PROJECTS', JSON.stringify(PROJECTS)); } catch (e) {}

        const gallery = document.getElementById('gallery');
        const filtersWrap = document.getElementById('filters');

        const allCats = new Set();
        PROJECTS.forEach(p => (p.categories || []).forEach(c => allCats.add(c)));
        const CATS = ['all', ...Array.from(allCats)];

        let active = 'all';

        function renderFilters(){
          filtersWrap.innerHTML = CATS.map(c =>
            `<button data-cat="${c}" class="${c===active?'active':''}">${c}</button>`
          ).join('');
          filtersWrap.querySelectorAll('button').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              active = btn.dataset.cat;
              renderFilters(); renderGallery();
              window.scrollTo({top:0, behavior:'smooth'});
            });
          });
        }

        function cardTemplate(p){
          const src = p.cover || p.thumb || FALLBACK_POSTER;
          return `
            <a class="card" data-type="${(p.media && p.media[0]?.type) || p.type || 'image'}"
               href="./project.html#${encodeURIComponent(p.slug)}" aria-label="${p.title}">
              <img loading="lazy" src="${src}" alt="${p.title}"
                   onerror="this.onerror=null; this.src='${FALLBACK_POSTER}'">
              <div class="meta"><div class="title">${p.title}</div></div>
            </a>
          `;
        }

        function renderGallery(){
          const items = PROJECTS.filter(p => active==='all' || (p.categories||[]).includes(active));
          gallery.innerHTML = items.map(cardTemplate).join('');
        }

        renderFilters();
        renderGallery();
      }

      loadProjects().then(PROJECTS => startApp(PROJECTS));
    </script>
  </body>
</html>

